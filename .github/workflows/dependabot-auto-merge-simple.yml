name: Dependabot Auto-merge

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]'

    steps:
      - name: Wait for checks to complete
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number: pull_number } = context.issue;
            const maxWaitTime = 10 * 60 * 1000; // 10 minutes
            const checkInterval = 30000; // 30 seconds
            let attempts = 0;

            // Patterns to exclude from required checks (case-insensitive)
            const excludePatterns = [
              /security/i,
              /codeql/i,
              /auto-merge/i,
              /dependabot/i,
              /conflicting/i,
              /refresh.*bot/i,
              /code scanning/i
            ];

            const shouldExclude = (name) => excludePatterns.some(pattern => pattern.test(name));

            console.log(`üîç Waiting for checks on PR #${pull_number}...`);

            while (attempts < maxWaitTime / checkInterval) {
              attempts++;

              try {
                // Get check runs for the PR
                const { data: checkRuns } = await github.rest.checks.listForRef({
                  owner,
                  repo,
                  ref: context.payload.pull_request.head.sha,
                });

                // Log all checks for debugging on first attempt
                if (attempts === 1) {
                  console.log('üìã All checks:', checkRuns.check_runs.map(c => `${c.name} (${c.status})`).join(', '));
                }

                const pendingChecks = checkRuns.check_runs.filter(
                  run => run.status !== 'completed' && !shouldExclude(run.name)
                );

                const failedChecks = checkRuns.check_runs.filter(
                  run => run.status === 'completed' && 
                         run.conclusion === 'failure' &&
                         !shouldExclude(run.name)
                );

                console.log(`üìä Pending: ${pendingChecks.length}, Failed (non-security): ${failedChecks.length}`);
                if (pendingChecks.length > 0) {
                  console.log(`‚è≥ Waiting for: ${pendingChecks.map(c => c.name).join(', ')}`);
                }

                if (failedChecks.length > 0) {
                  console.log(`‚ùå Failed checks: ${failedChecks.map(c => c.name).join(', ')}`);
                  core.setFailed('Required checks failed');
                  return;
                }

                if (pendingChecks.length === 0) {
                  console.log('‚úÖ All required checks passed!');
                  return;
                }
              } catch (error) {
                console.log(`‚ö†Ô∏è  Error checking status: ${error.message}`);
              }

              console.log(`‚è≥ Waiting... (attempt ${attempts})`);
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }

            console.log('‚è∞ Timeout waiting for status checks');
            core.setFailed('Timeout waiting for status checks');

      - name: Get Dependabot metadata
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Auto-merge if safe
        if: steps.dependabot-metadata.outputs.update-type == 'version-update:semver-patch' || steps.dependabot-metadata.outputs.update-type == 'version-update:semver-minor' || startsWith(github.event.pull_request.title, 'security')
        run: |
          PR_URL="${{ github.event.pull_request.html_url }}"
          UPDATE_TYPE="${{ steps.dependabot-metadata.outputs.update-type }}"

          echo "üîÑ Auto-merging Dependabot PR: $UPDATE_TYPE"

          # Approve the PR
          gh pr review --approve "$PR_URL"

          # Enable auto-merge
          gh pr merge --auto --squash "$PR_URL"

          echo "‚úÖ Auto-merge enabled for PR"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on auto-merge
        if: steps.dependabot-metadata.outputs.update-type == 'version-update:semver-patch' || steps.dependabot-metadata.outputs.update-type == 'version-update:semver-minor' || startsWith(github.event.pull_request.title, 'security')
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number: pull_number } = context.issue;
            const updateType = '${{ steps.dependabot-metadata.outputs.update-type }}';

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pull_number,
              body: `ü§ñ This Dependabot PR has been automatically approved and enabled for auto-merge.\n\n**Update Type:** ${updateType}\n**PR:** #${pull_number}`
            });