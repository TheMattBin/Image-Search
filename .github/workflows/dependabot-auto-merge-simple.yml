name: Dependabot Auto-merge

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]'

    steps:
      - name: Wait for checks to complete
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo, number: pull_number } = context.issue;
            const maxWaitTime = 10 * 60 * 1000; // 10 minutes
            const checkInterval = 30000; // 30 seconds
            const initialDelay = 60000; // Wait 60 seconds for checks to register
            let attempts = 0;

            // Check names to exclude (case-insensitive substring match)
            const excludeKeywords = [
              'security',
              'codeql',
              'auto-merge',
              'dependabot',
              'conflicting',
              'refresh',
              'code scanning'
            ];

            const shouldExclude = (name) => {
              const lowerName = name.toLowerCase();
              return excludeKeywords.some(keyword => lowerName.includes(keyword));
            };

            console.log(`ðŸ” Waiting for checks on PR #${pull_number}...`);
            
            // Initial delay to let other workflows register
            console.log(`â³ Initial wait (${initialDelay/1000}s) for checks to register...`);
            await new Promise(resolve => setTimeout(resolve, initialDelay));

            while (attempts < maxWaitTime / checkInterval) {
              attempts++;

              try {
                // Get check runs for the PR
                const { data: checkRuns } = await github.rest.checks.listForRef({
                  owner,
                  repo,
                  ref: context.payload.pull_request.head.sha,
                });

                // Log all checks for debugging on first attempt
                if (attempts === 1) {
                  console.log('ðŸ“‹ All checks:', checkRuns.check_runs.map(c => `${c.name} (${c.status}, excluded: ${shouldExclude(c.name)})`).join(', '));
                }

                const pendingChecks = checkRuns.check_runs.filter(
                  run => run.status !== 'completed' && !shouldExclude(run.name)
                );

                const failedChecks = checkRuns.check_runs.filter(
                  run => run.status === 'completed' && 
                         run.conclusion === 'failure' &&
                         !shouldExclude(run.name)
                );

                console.log(`ðŸ“Š Pending: ${pendingChecks.length}, Failed (non-security): ${failedChecks.length}`);
                if (pendingChecks.length > 0) {
                  console.log(`â³ Waiting for: ${pendingChecks.map(c => c.name).join(', ')}`);
                }

                if (failedChecks.length > 0) {
                  console.log(`âŒ Failed checks: ${failedChecks.map(c => c.name).join(', ')}`);
                  core.setFailed('Required checks failed');
                  return;
                }

                if (pendingChecks.length === 0) {
                  console.log('âœ… All required checks passed!');
                  return;
                }
              } catch (error) {
                console.log(`âš ï¸  Error checking status: ${error.message}`);
              }

              console.log(`â³ Waiting... (attempt ${attempts})`);
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }

            console.log('â° Timeout waiting for status checks');
            core.setFailed('Timeout waiting for status checks');

      - name: Get Dependabot metadata
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Log update type
        run: |
          echo "ðŸ“¦ Update type: ${{ steps.dependabot-metadata.outputs.update-type }}"
          echo "ðŸ“¦ Dependency names: ${{ steps.dependabot-metadata.outputs.dependency-names }}"
          echo "ðŸ“¦ Package ecosystem: ${{ steps.dependabot-metadata.outputs.package-ecosystem }}"

      - name: Auto-merge if safe
        if: steps.dependabot-metadata.outputs.update-type == 'version-update:semver-patch' || steps.dependabot-metadata.outputs.update-type == 'version-update:semver-minor' || steps.dependabot-metadata.outputs.update-type == 'version-update:semver-major' || contains(github.event.pull_request.title, 'security')
        run: |
          PR_URL="${{ github.event.pull_request.html_url }}"
          UPDATE_TYPE="${{ steps.dependabot-metadata.outputs.update-type }}"

          echo "ðŸ”„ Auto-merging Dependabot PR: $UPDATE_TYPE"

          # Approve the PR
          gh pr review --approve "$PR_URL"

          # Merge directly (not --auto) since checks already passed
          gh pr merge --squash "$PR_URL" --delete-branch || echo "âš ï¸ Direct merge failed, trying auto-merge"
          
          # Fallback to auto-merge if direct merge fails (e.g., branch protection)
          gh pr merge --auto --squash "$PR_URL" 2>/dev/null || true

          echo "âœ… Merge initiated for PR"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on auto-merge
        if: steps.dependabot-metadata.outputs.update-type == 'version-update:semver-patch' || steps.dependabot-metadata.outputs.update-type == 'version-update:semver-minor' || steps.dependabot-metadata.outputs.update-type == 'version-update:semver-major' || contains(github.event.pull_request.title, 'security')
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo, number: pull_number } = context.issue;
            const updateType = '${{ steps.dependabot-metadata.outputs.update-type }}';

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pull_number,
              body: `ðŸ¤– This Dependabot PR has been automatically approved and enabled for auto-merge.\n\n**Update Type:** ${updateType}\n**PR:** #${pull_number}`
            });