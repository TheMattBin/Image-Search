name: Security Scanning

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '30 1 * * 1'  # Weekly on Monday at 1:30 AM

permissions:
  contents: read
  security-events: write

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit bandit
          pip install -r requirements.txt

      - name: Run pip-audit (Python security)
        run: |
          pip-audit --vulnerability-service osv --output pip-audit-report.json --format json || true
          pip-audit --vulnerability-service osv --ignore-vuln GHSA-0000-0000-0000 2>&1 | tee pip-audit-output.txt || true

      - name: Check for high/critical Python vulnerabilities
        run: |
          # Fail only if high/critical vulnerabilities are found
          if pip-audit --vulnerability-service osv 2>&1 | grep -iE "(high|critical)"; then
            echo "::error::High or critical Python vulnerabilities found"
            exit 1
          fi
          echo "No high/critical Python vulnerabilities found"
        continue-on-error: true

      - name: Run Bandit (Python security linter)
        run: |
          bandit -r backend/ -f json -o bandit-report.json -ll || true
          bandit -r backend/ -ll || true

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install npm dependencies
        run: |
          cd frontend
          npm install

      - name: Run npm audit (high/critical only)
        run: |
          cd frontend
          npm audit --json > npm-audit-report.json || true
          npm audit --audit-level=high || echo "::warning::npm audit found vulnerabilities (non-blocking for moderate/low)"

      - name: Upload security reports
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: security-reports
          path: |
            pip-audit-report.json
            pip-audit-output.txt
            bandit-report.json
            frontend/npm-audit-report.json

  codeql-analysis:
    runs-on: ubuntu-latest
    permissions:
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python, javascript
          queries: security-extended

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        continue-on-error: true